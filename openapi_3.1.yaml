openapi: 3.0.3
info:
  title: SmartAI Proposal Builder API (Dev)
  version: "1.0.0"
  description: |
    Backend API for SmartAI Proposal Builder.

    Core principles:
    - **Grant-agnostic**: session carries `grant` (e.g., EDG, PSG) and the unified `/v1/draft`
      endpoint chooses the correct prompt pack.
    - **Config-driven**: pack versions and models are driven via Azure App Configuration
      (`PROMPT_PACK_LATEST.*`, `MODEL.*`, feature flags).
    - **Evidence-aware**: drafts are grounded on pre-processed evidence snippets stored per session.

servers:
  - url: https://sgdev-smartai-api-01.azurewebsites.net
    description: Dev environment

tags:
  - name: system
    description: Healthcheck and basic info
  - name: config
    description: Feature flags and prompt configuration
  - name: sessions
    description: Session lifecycle, facts, validation, checklist
  - name: drafting
    description: Grant-agnostic and grant-specific draft generation
  - name: evidence
    description: Evidence observability and debug tools
  - name: debug
    description: Miscellaneous debug / ops endpoints (non-production)

paths:
  /:
    get:
      tags: [system]
      summary: Root service probe
      description: Lightweight root probe for platform checks.
      responses:
        "200":
          description: Service is up
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RootProbe'

  /health:
    get:
      tags: [system]
      summary: Healthcheck
      description: Returns 200 if the API is healthy.
      responses:
        "200":
          description: Healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthProbe'

  /v1/config/features:
    get:
      tags: [config]
      summary: Frontend feature flags and latest pack versions
      description: |
        Returns high-level configuration for frontend clients:
        - Whether PSG flow is enabled
        - Worker model name
        - Latest approved versions for known packs (EDG, PSG).

        This is a **stable contract for the UI** and does not expose
        environment-specific details like App Config labels.
      responses:
        "200":
          description: Current feature configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeaturesConfig'

  /v1/prompts/active:
    get:
      tags: [config]
      summary: Active prompt configuration (ops / observability)
      description: |
        Returns the currently active pack versions and model pins as seen
        by this running instance.

        Intended for **ops and debugging**, not for general frontend use.
        Useful when running canaries (different App Config labels per revision).
      responses:
        "200":
          description: Active prompt configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptsActive'

  /v1/session:
    post:
      tags: [sessions]
      summary: Create a new session
      description: |
        Creates a new session row keyed by a generated `session_id`.

        `grant` is used to choose the appropriate checklist and prompt pack
        (e.g., EDG vs PSG). Additional facts are captured later via `/facts`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionCreate'
      responses:
        "200":
          description: Session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionCreated'

  /v1/session/{sid}:
    get:
      tags: [sessions]
      summary: Get session metadata
      description: |
        Returns raw session metadata stored in the underlying session table,
        including any facts previously upserted via `/facts` or `/eligibility`.
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        "200":
          description: Session metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionDetails'
        "404":
          description: Session not found

  /v1/session/{sid}/facts:
    post:
      tags: [sessions]
      summary: Upsert facts for a session (canonical)
      description: |
        Upserts structured facts for a session. This is the **canonical**
        endpoint for eligibility, profiling and diagnostics.

        - Supports EDG/PSG eligibility fields (local equity, turnover, headcount)
        - Supports grant attestations (used_in_singapore, no_payment_before_application)
        - Accepts `extra` map for free-form key/value extension (lead-gen, vendor profiling, etc.)

        Data is flattened into the session row and can be reused by
        `/validate` and `/v1/draft`.
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionFactsReq'
      responses:
        "200":
          description: Facts upserted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionFactsResponse'
        "404":
          description: Session not found

  /v1/session/{sid}/eligibility:
    post:
      tags: [sessions]
      summary: Upsert eligibility facts (legacy alias)
      description: |
        Backward-compatible alias for `/v1/session/{sid}/facts`.

        **Deprecated for new integrations.** Use `/v1/session/{sid}/facts` instead.
      deprecated: true
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionFactsReq'
      responses:
        "200":
          description: Facts upserted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionFactsResponse'
        "404":
          description: Session not found

  /v1/session/{sid}/validate:
    post:
      tags: [sessions]
      summary: Run validation rules against session facts
      description: |
        Executes non-blocking validation checks over stored session facts.

        Currently implemented rule set (extensible):
        - `PSG.ELIG.LOCAL_EQUITY_MIN_30` (warning) if:
          - `grant == "PSG"` AND `local_equity_pct < 30`.

        This endpoint is designed to:
        - Power lightweight UX validation banners
        - Provide a hook for future business rule engines
        - Run independently of drafting.
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        "200":
          description: Validation checks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        "404":
          description: Session not found

  /v1/session/{sid}/checklist:
    get:
      tags: [sessions]
      summary: Get grant-aware checklist of tasks for a session
      description: |
        Returns the list of tasks (uploads + drafts) for the given session,
        based on its `grant` type.

        Examples:
        - For EDG: upload ACRA, upload financials, draft consultancy scope,
          draft about_project (with section_variant), draft expansion_plan.
        - For PSG: upload vendor quotation, upload cost breakdown, draft business_impact, etc.

        The `section_variant` field is used for EDG sub-flows (e.g., I&P, Market Access).
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        "200":
          description: Checklist of tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChecklistResponse'

  /v1/session/{sid}/checklisttest:
    get:
      tags: [sessions]
      summary: Get dynamically-generated checklist of tasks for a session (test endpoint)
      description: |
        Returns a dynamically-generated list of tasks (uploads + drafts) for the given session,
        built from `pack.yml` configuration and the Azure Search template index.

        This is a **test endpoint** for verification before replacing the original `/checklist` endpoint.
        It provides the same functionality as `/checklist` but with dynamic generation capabilities.

        **Key differences from `/checklist`:**
        - Uses `pack` field instead of `grant` (semantic rename)
        - Dynamically built from `pack.yml` and Azure Search index
        - Supports automatic variant resolution based on session context
        - Falls back to hardcoded list on any error (graceful degradation)
        - Only includes approved templates (respects template-level status)

        **Examples:**
        - For EDG: upload ACRA, upload financials, draft consultancy scope,
          draft about_project (with section_variant), draft expansion_plan.
        - For PSG: upload vendor quotation, upload cost breakdown, draft business_impact, etc.

        The `section_variant` field is used for EDG sub-flows (e.g., I&P, Market Access).
        Variants are automatically resolved based on session data when available.
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
      responses:
        "200":
          description: Dynamically-generated checklist of tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChecklistTestResponse'
        "404":
          description: Session not found

  /v1/draft:
    post:
      tags: [drafting]
      summary: Unified grant-agnostic draft endpoint
      description: |
        Generates a draft for a specific section in the context of a session.

        - Determines grant from the session (`grant` field).
        - Chooses appropriate prompt pack (EDG or PSG) via internal prompt vault.
        - Automatically loads relevant evidence snippets (e.g., ACRA, vendor_quotation).
        - Applies soft evaluation (structure/groundedness checks).

        This is the **preferred endpoint** for new clients.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DraftReq'
      responses:
        "200":
          description: Draft generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftResponse'
        "404":
          description: Session not found
        "400":
          description: Model deployment / configuration error
        "500":
          description: Internal failure (prompt vault, AI service, or evidence access)

  /v1/grants/edg/draft:
    post:
      tags: [drafting]
      summary: EDG-specific draft endpoint (legacy wrapper)
      description: |
        Backward-compatible EDG-specific draft endpoint.

        Internally forwards to the unified draft logic with `pack_hint="edg"`.

        **Deprecated for new integrations.** Prefer `/v1/draft`.
      deprecated: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DraftReq'
      responses:
        "200":
          description: Draft generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftResponse'

  /v1/grants/psg/draft:
    post:
      tags: [drafting]
      summary: PSG-specific draft endpoint (legacy wrapper)
      description: |
        Backward-compatible PSG-specific draft endpoint.

        Internally forwards to the unified draft logic with `pack_hint="psg"`.

        **Deprecated for new integrations.** Prefer `/v1/draft`.
      deprecated: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DraftReq'
      responses:
        "200":
          description: Draft generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftResponse'

  /v1/debug/evidence/{sid}:
    get:
      tags: [evidence]
      summary: List evidence blobs for a session
      description: |
        Lists evidence blobs associated with a session and (optionally) returns
        a preview snippet for each.

        Evidence blobs follow naming convention:
        `"{session_id}_{label}.txt"`.
      parameters:
        - $ref: '#/components/parameters/SessionIdPath'
        - name: preview
          in: query
          description: |
            Maximum number of characters to include as preview for each evidence
            blob. 0 returns metadata only.
          required: false
          schema:
            type: integer
            minimum: 0
            maximum: 4000
            default: 0
      responses:
        "200":
          description: Evidence items for the session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidenceListResponse'
        "500":
          description: Evidence listing failed

  /v1/debug/packs:
    get:
      tags: [debug]
      summary: Inspect prompt pack templates via search index
      description: |
        Debug endpoint to list templates for a given pack and version by querying
        Azure AI Search.

        **Dev/ops only; not intended for frontend use.**
      parameters:
        - name: pack
          in: query
          required: false
          schema:
            type: string
            default: psg
          description: Pack identifier (e.g. "edg", "psg").
        - name: ver
          in: query
          required: false
          schema:
            type: string
            default: latest-approved
          description: Specific version or "latest-approved".
      responses:
        "200":
          description: Pack sections and templates
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebugPacksResponse'

  /v1/debug/whereami:
    get:
      tags: [debug]
      summary: Show backend search configuration
      description: |
        Simple debug endpoint that returns the configured Azure Search
        endpoint and index, without exposing any secrets.
      responses:
        "200":
          description: Search configuration probe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WhereAmIResponse'

components:
  parameters:
    SessionIdPath:
      name: sid
      in: path
      required: true
      schema:
        type: string
      description: Server-generated session identifier (e.g. "s_ab12cd34").

  schemas:
    RootProbe:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        service:
          type: string
          example: smartai-api

    HealthProbe:
      type: object
      properties:
        ok:
          type: boolean
          example: true

    FeaturesConfig:
      type: object
      properties:
        feature_psg_enabled:
          type: boolean
          description: Whether PSG flows are enabled in this environment.
        model_worker:
          type: string
          description: Name of the worker model deployment.
        packs_latest:
          type: object
          description: Latest approved versions of known packs.
          properties:
            EDG:
              type: string
              nullable: true
              example: "1.0.0"
            PSG:
              type: string
              nullable: true
              example: "1.0.0"

    PromptsActive:
      type: object
      properties:
        packs_latest:
          $ref: '#/components/schemas/FeaturesConfig/properties/packs_latest'
        model_worker:
          type: string
          description: Effective worker model for this instance.
        model_manager:
          type: string
          description: Manager/orchestrator model (if used).
        feature_psg_enabled:
          type: boolean
        appconfig_label:
          type: string
          description: App Config label used by this running instance (e.g., "dev", "stable", "canary").

    SessionCreate:
      type: object
      required: [grant]
      properties:
        grant:
          type: string
          description: Grant type identifier (e.g. "EDG", "PSG").
          example: EDG
        company_name:
          type: string
          nullable: true
          description: Optional company name for display and prompts.

    SessionCreated:
      type: object
      properties:
        session_id:
          type: string
          example: s_ab12cd34

    SessionDetails:
      type: object
      properties:
        session_id:
          type: string
        session:
          type: object
          additionalProperties: true
          description: Raw session row including any stored facts.

    SessionFactsReq:
      type: object
      description: |
        Generic session fact capture for eligibility, profiling, and diagnostics.
        All fields are optional; unset fields are ignored on upsert.
      properties:
        local_equity_pct:
          type: number
          format: float
          minimum: 0
          maximum: 100
          nullable: true
          description: Local equity percentage.
        turnover:
          type: number
          format: float
          minimum: 0
          nullable: true
          description: Annual turnover/revenue.
        headcount:
          type: integer
          minimum: 0
          nullable: true
          description: Number of employees.
        used_in_singapore:
          type: boolean
          nullable: true
          description: Whether the grant-funded outcome will be used in Singapore.
        no_payment_before_application:
          type: boolean
          nullable: true
          description: Whether no payment was made before the application.
        extra:
          type: object
          nullable: true
          additionalProperties: true
          description: |
            Free-form key-value facts, e.g. {"industry":"F&B","budget_range":"<50k"}.

    SessionFactsResponse:
      type: object
      properties:
        session_id:
          type: string
        facts:
          type: object
          additionalProperties: true
          description: Flattened map of all fields applied in this call.

    ValidationCheck:
      type: object
      properties:
        code:
          type: string
          description: Machine-readable rule code (e.g. PSG.ELIG.LOCAL_EQUITY_MIN_30).
        level:
          type: string
          description: Severity level (e.g. "warning", "error").
        message:
          type: string
          description: Human-readable description of the issue.

    ValidationResult:
      type: object
      properties:
        session_id:
          type: string
        checks:
          type: array
          items:
            $ref: '#/components/schemas/ValidationCheck'

    ChecklistTask:
      type: object
      properties:
        id:
          type: string
          description: Logical task identifier (e.g. "acra_bizfile", "business_impact").
        type:
          type: string
          description: Task type.
          enum: [upload, draft]
        section_variant:
          type: string
          nullable: true
          description: Optional variant key for section (e.g. "about_project.i_and_p.automation").

    ChecklistResponse:
      type: object
      properties:
        session_id:
          type: string
        grant:
          type: string
          description: Effective grant for this session (uppercased).
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/ChecklistTask'

    ChecklistTestResponse:
      type: object
      properties:
        session_id:
          type: string
          description: Session identifier.
        pack:
          type: string
          description: Effective pack identifier for this session (uppercased, e.g. "EDG", "PSG").
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/ChecklistTask'
          description: |
            Dynamically-generated list of tasks (uploads + drafts) built from pack.yml
            configuration and Azure Search template index. Tasks are ordered with uploads
            first, followed by draft sections in the order specified in pack.yml.

    DraftReq:
      type: object
      required: [session_id, section_id]
      properties:
        session_id:
          type: string
          description: Existing session identifier.
        section_id:
          type: string
          description: Logical section identifier to draft (e.g. "business_impact").
        section_variant:
          type: string
          nullable: true
          description: Optional variant key for sub-flows (EDG I&P vs Core vs Market Access).
        inputs:
          type: object
          additionalProperties: true
          description: |
            Arbitrary input map, including:
            - freeform text fields
            - evidence selection overrides (evidence_labels / evidence_label)
            - evidence_char_cap overrides.

    DraftEvaluation:
      type: object
      description: Soft evaluation result for a draft.
      properties:
        score:
          type: integer
          description: Aggregate quality score (implementation-specific).
          example: 55
        fails:
          type: array
          items:
            type: string
          description: List of evaluation rule failures (e.g. "missing:source:").

    DraftResponse:
      type: object
      properties:
        section_id:
          type: string
        framework:
          type: string
          description: Framework chosen for this section (e.g. "SCQA", "PAS").
        evidence_used:
          type: array
          items:
            type: string
          description: Evidence labels actually used in this draft, ordered.
        output:
          type: string
          description: Generated draft text.
        evaluation:
          $ref: '#/components/schemas/DraftEvaluation'
        warnings:
          type: array
          description: Non-blocking warnings (currently empty; reserved for future rules).
          items:
            $ref: '#/components/schemas/ValidationCheck'

    EvidenceItem:
      type: object
      properties:
        name:
          type: string
          description: Underlying blob name (e.g. "s_ab12cd34_acra_bizfile.txt").
        label:
          type: string
          description: Logical evidence label (suffix without session prefix or extension).
        chars:
          type: integer
          nullable: true
          description: Number of characters in the evidence text (if preview loaded).
        preview:
          type: string
          nullable: true
          description: Preview snippet (up to `preview` chars) if requested.

    EvidenceListResponse:
      type: object
      properties:
        session_id:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'

    DebugPacksResponse:
      type: object
      properties:
        pack:
          type: string
          description: Resolved pack identifier (uppercased).
        version:
          type: string
          description: Resolved version (concrete or "latest-approved").
        sections:
          type: array
          items:
            type: string
          description: Distinct section IDs present in this pack/version.
        items:
          type: array
          items:
            type: object
            properties:
              section_id:
                type: string
                nullable: true
              template_key:
                type: string
                nullable: true
              version:
                type: string
                nullable: true

    WhereAmIResponse:
      type: object
      properties:
        endpoint:
          type: string
          nullable: true
          description: Azure Search endpoint configured for this instance.
        index:
          type: string
          description: Azure Search index name.
        probe:
          type: string
          example: ok